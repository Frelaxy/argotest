---

- name: add apt keyring
  # become: true
  ansible.builtin.shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

- name: Adding apt repository for Kubernetes
  # become: true
  ansible.builtin.shell: |
    echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list

- name: Install Kubernetes binaries
  apt: 
    # name: "{{ packages }}"
    state: present
    update_cache: yes
    pkg:
      - kubelet 
      - kubeadm 
      - kubectl
  register: apt_get_status
  until: apt_get_status is success
  retries: 60
  delay: 10

- name: Configure node ip
  lineinfile:
    path: /etc/default/kubelet
    line: KUBELET_EXTRA_ARGS=--node-ip={{ ansible_host }}

- name: Restart kubelet
  service:
    name: kubelet
    daemon_reload: yes
    state: restarted